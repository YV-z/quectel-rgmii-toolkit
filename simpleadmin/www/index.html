<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Admin</title>
  <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    /> -->
  <!-- Import all the bootstrap css files from css folder -->
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/bootstrap.min.css" />

  <!-- Logo -->
  <link rel="simpleadmin-logo" href="favicon.ico" />

  <!--  Import BootStrap Javascript -->
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/alpinejs.min.js" defer></script>
</head>

<body>
  <main>
    <div class="container my-4" x-data="processAllInfos()">
      <nav class="navbar navbar-expand-lg mt-2">
        <div class="container-fluid">
          <a class="navbar-brand" href="/"><span class="mb-0 h4">Simple Admin</span></a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText"
            aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarText">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="network.html">Simple Network</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/scanner.html">Simple Scan</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/settings.html">Simple Settings</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/sms.html">SMS</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/console">Console</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/deviceinfo.html">Device Information</a>
              </li>
            </ul>
            <span class="navbar-text">
              <button class="btn btn-link text-reset" id="darkModeToggle">
                Dark Mode
              </button>
            </span>
          </div>
        </div>
      </nav>

      <div class="row align-items-center mt-5 gap-md-3 gap-2">
        <div class="col align-self-center">
          <div class="card">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" height="85" width="85">
                <path fill="#fdb53c"
                  d="M160 64c-26.5 0-48 21.5-48 48V276.5c0 17.3-7.1 31.9-15.3 42.5C86.2 332.6 80 349.5 80 368c0 44.2 35.8 80 80 80s80-35.8 80-80c0-18.5-6.2-35.4-16.7-48.9c-8.2-10.6-15.3-25.2-15.3-42.5V112c0-26.5-21.5-48-48-48zM48 112C48 50.2 98.1 0 160 0s112 50.1 112 112V276.5c0 .1 .1 .3 .2 .6c.2 .6 .8 1.6 1.7 2.8c18.9 24.4 30.1 55 30.1 88.1c0 79.5-64.5 144-144 144S16 447.5 16 368c0-33.2 11.2-63.8 30.1-88.1c.9-1.2 1.5-2.2 1.7-2.8c.1-.3 .2-.5 .2-.6V112zM208 368c0 26.5-21.5 48-48 48s-48-21.5-48-48c0-20.9 13.4-38.7 32-45.3V272c0-8.8 7.2-16 16-16s16 7.2 16 16v50.7c18.6 6.6 32 24.4 32 45.3z" />
              </svg>
              <h1 class="card-text mt-4" x-text="temperature + ' &deg;C'"></h1>
            </div>
            <div class="card-footer">Temperature</div>
          </div>
        </div>

        <div class="col align-self-center">
          <div class="card">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" height="85" width="85">
                <path fill="#6a46d8"
                  d="M64 0H242.7c17 0 33.3 6.7 45.3 18.7L365.3 96c12 12 18.7 28.3 18.7 45.3V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64C0 28.7 28.7 0 64 0zM96 192c-17.7 0-32 14.3-32 32v32h64V192H96zM64 352h80 96 80V288H240 144 64v64zM320 224c0-17.7-14.3-32-32-32H256v64h64V224zM160 192v64h64V192H160zM288 448c17.7 0 32-14.3 32-32V384H256v64h32zM160 384v64h64V384H160zM64 416c0 17.7 14.3 32 32 32h32V384H64v32z" />
              </svg>
              <h1 class="card-text mt-4" x-text="simStatus"></h1>
            </div>
            <div class="card-footer">SIM Status</div>
          </div>
        </div>

        <div class="col align-self-center">
          <div class="card">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="85" width="85">
                <path fill="#2fa7fb"
                  d="M576 0c17.7 0 32 14.3 32 32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V32c0-17.7 14.3-32 32-32zM448 96c17.7 0 32 14.3 32 32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32zM352 224V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32s32 14.3 32 32zM192 288c17.7 0 32 14.3 32 32V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V320c0-17.7 14.3-32 32-32zM96 416v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V416c0-17.7 14.3-32 32-32s32 14.3 32 32z" />
              </svg>
              <h1 class="card-text mt-4" x-text="signalPercentage + '%'"></h1>
            </div>
            <div class="card-footer">Signal Percentage</div>
          </div>
        </div>

        <div class="col align-self-center">
          <div class="card">
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" height="85" width="85">
                <path fill="#20c0ae"
                  d="M0 336c0 79.5 64.5 144 144 144H512c70.7 0 128-57.3 128-128c0-61.9-44-113.6-102.4-125.4c4.1-10.7 6.4-22.4 6.4-34.6c0-53-43-96-96-96c-19.7 0-38.1 6-53.3 16.2C367 64.2 315.3 32 256 32C167.6 32 96 103.6 96 192c0 2.7 .1 5.4 .2 8.1C40.2 219.8 0 273.2 0 336z" />
              </svg>
              <h1 class="card-text mt-4" x-text="internetConnectionStatus"></h1>
            </div>
            <div class="card-footer">Internet Connection</div>
          </div>
        </div>
      </div>

      <div class="row mt-5 gap-3">
        <div class="col">
          <div class="card">
            <div class="card-header">Network Information</div>
            <div class="card-body">
              <div class="card-text table-responsive-sm">
                <table class="table">
                  <tbody>
                    <tr>
                      <th scope="row">Active Sim</th>
                      <td x-text="activeSim"></td>
                    </tr>
                    <tr>
                      <th scope="row">Network Provider</th>
                      <td x-text="networkProvider"></td>
                    </tr>
                    <tr>
                      <th scope="row">MCCMNC</th>
                      <td x-text="mccmnc"></td>
                    </tr>
                    <tr>
                      <th scope="row">APN</th>
                      <td x-text="apn"></td>
                    </tr>
                    <tr>
                      <th scope="row">Network Mode</th>
                      <td x-text="networkMode"></td>
                    </tr>
                    <tr>
                      <th scope="row">Bands</th>
                      <td x-text="bands"></td>
                    </tr>
                    <tr>
                      <th scope="row">Bandwidth</th>
                      <td x-text="bandwidth"></td>
                    </tr>
                    <tr>
                      <th scope="row">E/ARFCN<sup>4G/5G</sup></th>
                      <td x-text="earfcns"></td>
                    </tr>
                    <tr>
                      <th scope="row">PCI</th>
                      <td x-show="sccPCI != '-'" x-text="pccPCI + ', ' + sccPCI"></td>

                      <td x-show="sccPCI == '-'" x-text="pccPCI"></td>
                    </tr>
                    <tr>
                      <th scope="row">IPv<sup>4</sup></th>
                      <td x-text="ipv4"></td>
                    </tr>
                    <tr>
                      <th scope="row">IPv<sup>6</sup></th>
                      <td x-text="ipv6"></td>
                    </tr>
                    <tr>
                      <th scope="row">Uptime</th>
                      <td x-text="uptime"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer">
              <div class="row row-cols-2">
                <div class="col">
                  <p class="btn">Refresh Rate (min 3s)</p>
                </div>
                <div class="col">
                  <div class="input-group">
                    <input x-model="newRefreshRate" class="form-control" type="number" min="3" max="60"
                      x-bind:placeholder="refreshRate + 's'" />
                    <button @click="updateRefreshRate()" class="btn btn-outline-secondary" type="button">
                      Set
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card">
            <div class="card-header">Signal Information</div>
            <div class="card-body">
              <div class="card-text table-responsive-sm">
                <table class="table">
                  <tbody>
                    <tr>
                      <th scope="row">Assessment</th>
                      <td x-text="signalAssessment"></td>
                    </tr>
                    <tr>
                      <th scope="row">Traffic Stats</th>
                      <td x-text="downloadStat + ' DL / ' + uploadStat + ' UL'"></td>
                    </tr>
                    <tr x-show="csq != 'NR-SA Mode'">
                      <th scope="row">CSQ</th>
                      <td x-show="csq != '-'" x-text="csq"></td>
                      <td x-show="csq == '-'" class="fst-italic">None</td>
                    </tr>
                    <tr>
                      <th scope="row">CELL ID</th>
                      <td x-text="cellID"></td>
                    </tr>
                    <tr>
                      <th scope="row">eNB ID <sup>4G/5G</sup></th>
                      <td x-text="eNBID"></td>
                    </tr>
                    <tr>
                      <th scope="row">TAC<sup>4G/5G</sup></th>
                      <td x-text="tac"></td>
                    </tr>
                    <!-- <tr x-show="rssi != '-'">
                        <th scope="row">RSSI<sup>4G</sup></th>
                        <td x-show="rssi != '-'" x-text="rssi"></td>
                        <td x-show="rssi == '-'" class="fst-italic">None</td>
                      </tr> -->
                    <tr x-show="rsrqLTE != '-'">
                      <th scope="row">SS_RSRQ<sup>4G</sup></th>
                      <td class="gap-4 align-items-center" x-data="{ getProgressBarClass: function() {
                          // Remove the percentage sign and convert to integer
                          var percentage = parseInt(this.rsrqLTEPercentage);
                          
                          if (percentage >= 60) {
                              return 'progress-bar bg-success is-medium';
                          } else if (percentage >= 40) {
                              return 'progress-bar bg-warning is-warning is-medium';
                          } else {
                              return 'progress-bar bg-danger is-medium';
                          }
                      } }">
                        <div x-show="rsrqLTE != '-' && rsrqLTEPercentage != '0'" class="progress w-100"
                          role="progressbar" aria-label="RSRQ BAR" :aria-valuenow="rsrqLTEPercentage" aria-valuemin="0"
                          aria-valuemax="100" style="height: 18px">
                          <div :class="getProgressBarClass()" :style="'width: ' + rsrqLTEPercentage + '%'">
                            <span x-text="rsrqLTE + ' / ' +  rsrqLTEPercentage + '%'"></span>
                          </div>
                        </div>
                        <span x-show="rsrqLTEPercentage == '0'" x-text="rsrqLTE"></span>
                        <span x-show="rsrqLTE == '-'" class="fst-italic">
                          None
                        </span>
                      </td>
                    </tr>
                    <tr x-show="rsrqNR != '-'">
                      <th scope="row">SS_RSRQ<sup>5G</sup></th>
                      <td x-data="{ getProgressBarClass: function() {
                          // Remove the percentage sign and convert to integer
                          var percentage = parseInt(this.rsrqNRPercentage);
                          
                          if (percentage >= 60) {
                              return 'progress-bar bg-success is-medium';
                          } else if (percentage >= 40) {
                              return 'progress-bar bg-warning is-warning is-medium';
                          } else {
                              return 'progress-bar bg-danger is-medium';
                          }
                      } }">
                        <div x-show="rsrqNR != '-' && rsrqNRPercentage != '0'" class="progress w-100" role="progressbar"
                          aria-label="RSRQ BAR" :aria-valuenow="rsrqNRPercentage" aria-valuemin="0" aria-valuemax="100"
                          style="height: 18px">
                          <div :class="getProgressBarClass()" :style="'width: ' + rsrqNRPercentage + '%'">
                            <span x-text="rsrqNR + ' / ' + rsrqNRPercentage + '%'"></span>
                          </div>
                        </div>
                        <span x-show="rsrqNRPercentage == '0'" x-text="rsrqNR"></span>
                        <span x-show="rsrqNR == '-'" class="fst-italic">
                          None
                        </span>
                      </td>
                    </tr>
                    <tr x-show="rsrpLTE != '-'">
                      <th scope="row">RSRP<sup>4G</sup></th>
                      <td class="gap-4 align-items-center" x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.rsrpLTEPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }">
                        <div x-show="rsrpLTE != '-' && rsrpLTEPercentage != '0'" class="progress w-100"
                          role="progressbar" aria-label="RSRP BAR" :aria-valuenow="rsrpLTEPercentage" aria-valuemin="0"
                          aria-valuemax="100" style="height: 18px">
                          <div :class="getProgressBarClass()" :style="'width: ' + rsrpLTEPercentage + '%'">
                            <span x-text="rsrpLTE + ' / ' + rsrpLTEPercentage + '%'"></span>
                          </div>
                        </div>
                        <span x-show="rsrpLTEPercentage == '0'" x-text="rsrpLTE"></span>
                        <span x-show="rsrpLTE == '-'" class="fst-italic">
                          None
                        </span>
                      </td>
                    </tr>
                    <tr x-show="rsrpNR != '-'">
                      <th scope="row">SS_RSRP<sup>5G</sup></th>
                      <td class="gap-4 align-items-center" x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.rsrpNRPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }">
                        <div x-show="rsrpNR != '-' && rsrpNRPercentage != '0'" class="progress w-100" role="progressbar"
                          aria-label="RSRP BAR" :aria-valuenow="rsrpNRPercentage" aria-valuemin="0" aria-valuemax="100"
                          style="height: 18px">
                          <div :class="getProgressBarClass()" :style="'width: ' + rsrpNRPercentage + '%'">
                            <span x-text="rsrpNR + ' / ' + rsrpNRPercentage + '%'"></span>
                          </div>
                        </div>
                        <span x-show="rsrpNRPercentage == '0'" x-text="rsrpNR"></span>
                        <span x-show="rsrpNR == '-'" class="fst-italic">
                          None
                        </span>
                      </td>
                    </tr>
                    <tr x-show="sinrLTE != '-'">
                      <th scope="row">SINR<sup>4G</sup></th>
                      <td class="gap-4 align-items-center" x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.sinrLTEPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }">
                        <div x-show="sinrLTE != '-' && sinrLTEPercentage != '0'" class="progress w-100"
                          role="progressbar" aria-label="SINR BAR" :aria-valuenow="sinrLTEPercentage" aria-valuemin="0"
                          aria-valuemax="100" style="height: 18px">
                          <div :class="getProgressBarClass()" :style="'width: ' + sinrLTEPercentage +'%'">
                            <span x-text="sinrLTE + ' / ' + sinrLTEPercentage +'%'"></span>
                          </div>
                        </div>
                        <span x-text="sinrLTE" x-show="sinrLTEPercentage == '0'"></span>
                        <span x-show="sinrLTE == '-'" class="fst-italic">
                          None
                        </span>
                      </td>
                    </tr>
                    <tr x-show="sinrNR != '-'">
                      <th scope="row">SINR<sup>5G</sup></th>
                      <td class="gap-4 align-items-center" x-data="{
                          getProgressBarClass: function() {
                              // Remove the percentage sign and convert to integer
                              var percentage = parseInt(this.sinrNRPercentage);
                              
                              if (percentage >= 60) {
                                  return 'progress-bar bg-success is-medium';
                              } else if (percentage >= 40) {
                                  return 'progress-bar bg-warning is-warning is-medium';
                              } else {
                                  return 'progress-bar bg-danger is-medium';
                              }
                          }
                        }">
                        <div x-show="sinrNR != '-' && sinrNRPercentage != '0'" class="progress w-100" role="progressbar"
                          aria-label="SINR BAR" :aria-valuenow="sinrNRPercentage" aria-valuemin="0" aria-valuemax="100"
                          style="height: 18px">
                          <div :class="getProgressBarClass()" :style="'width: ' + sinrNRPercentage +'%'">
                            <span x-text="sinrNR + ' / ' + sinrNRPercentage +'%'"></span>
                          </div>
                        </div>
                        <span x-text="sinrNR" x-show="sinrNRPercentage == '0'"></span>
                        <span x-show="sinrNR == '-'" class="fst-italic">
                          None
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer">
              <div class="card-text">
                <div class="row">
                  <div class="col">
                    <div>
                      <p>Date Updated</p>
                    </div>
                  </div>

                  <div class="col">
                    <p x-text="lastUpdate"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/dark-mode.js"></script>

  <script>
    function processAllInfos() {
      return {
        atcmd: "",
        internetConnectionStatus: "Disconnected",
        temperature: "0",
        simStatus: "No SIM",
        activeSim: "No SIM",
        networkProvider: "N/A",
        mccmnc: "00000",
        apn: "Unknown",
        networkMode: "Disconnected",
        bands: "Unknown Bands",
        bandwidth: "Unknown Bandwidth",
        earfcns: "000",
        pccPCI: "0",
        sccPCI: "-",
        ipv4: "000.000.000.000",
        ipv6: "0000:0000:0000:0000:0000:0000:0000:0000",
        cellID: "Unknown",
        eNBID: "Unknown",
        tac: "Unknown",
        csq: "-",
        rsrpLTE: "-",
        rsrpNR: "-",
        rsrpLTEPercentage: "0%",
        rsrpNRPercentage: "0%",
        rsrqLTE: "-",
        rsrqNR: "-",
        rsrqLTEPercentage: "0%",
        rsrqNRPercentage: "0%",
        sinrLTE: "-",
        sinrNR: "-",
        sinrLTEPercentage: "0%",
        sinrNRPercentage: "0%",
        signalPercentage: "0",
        signalAssessment: "Unknown",
        uptime: "Unknown",
        lastUpdate: new Date().toLocaleString(),
        newRefreshRate: null,
        refreshRate: 3,
        nrDownload: "0",
        nrUpload: "0",
        nonNrDownload: "0",
        nonNrUpload: "0",
        downloadStat: "0",
        uploadStat: "0",

        fetchAllInfo() {
          console.log("开始获取所有信息...");
          this.atcmd =
            'AT+QTEMP;+QUIMSLOT?;+QSPN;+CGCONTRDP=1;+QMAP="WWANIP";+QENG="servingcell";+QCAINFO;+QSIMSTAT?;+CSQ;+QGDNRCNT?;+QGDCNT?';

          fetch(
            "/cgi-bin/get_atcommand?" +
            new URLSearchParams({
              atcmd: this.atcmd,
            })
          )
            .then((response) => {
              return response.text();
            })
            .then((data) => {
              console.log("收到AT命令响应");
              console.log("原始响应数据:", data);

              // 即使有ERROR，也尝试解析可用数据
              const hasError = data.includes("ERROR");
              if (hasError) {
                console.warn("部分命令执行失败，但仍尝试解析可用数据");
              }

              const lines = data.split("\n");
              console.log("解析后的行数据:", lines);

              // --- 温度 ---
              try {
                console.log("开始解析温度...");
                let tempLine = lines.find(line => line.includes('+QTEMP:"cpuss-0-usr"'));
                if (!tempLine) {
                  tempLine = lines.find(line => line.includes('+QTEMP:"cpu0-a7-usr"'));
                }
                if (tempLine) {
                  this.temperature = tempLine.split(",")[1].replace(/"/g, "");
                }
                console.log("温度:", this.temperature);
              } catch (error) {
                console.error("温度解析失败:", error);
                this.temperature = "N/A";
              }

              // --- SIM状态 ---
              try {
                console.log("开始解析SIM状态...");
                const simLine = lines.find(line => line.includes("+QSIMSTAT:"));
                if (simLine) {
                  const sim_status = simLine.split(" ")[1].replace(/"/g, "").split(",")[1];
                  this.simStatus = sim_status == 1 ? "Active" : "No SIM";
                }
                console.log("SIM状态:", this.simStatus);
              } catch (error) {
                console.error("SIM状态解析失败:", error);
                this.simStatus = "Unknown";
              }

              // --- 活动SIM卡 ---
              try {
                console.log("开始解析活动SIM卡...");
                const simSlotLine = lines.find(line => line.includes("+QUIMSLOT:"));
                if (simSlotLine) {
                  const current_sim = simSlotLine.split(" ")[1].replace(/"/g, "");
                  this.activeSim = current_sim == 1 ? "SIM 1" : (current_sim == 2 ? "SIM 2" : "No SIM");
                }
                console.log("活动SIM卡:", this.activeSim);
              } catch (error) {
                console.error("活动SIM卡解析失败:", error);
                this.activeSim = "Unknown";
              }

              // --- 网络提供商 ---
              try {
                console.log("开始解析网络提供商...");
                const qspnLine = lines.find(line => line.includes("+QSPN:"));
                if (qspnLine) {
                  const parts = qspnLine.split(",");
                  if (parts.length >= 5) {
                    this.networkProvider = parts[2].replace(/"/g, "");
                    this.mccmnc = parts[4].replace(/"/g, "");
                  }
                }
                console.log("网络提供商:", this.networkProvider);
                console.log("MCCMNC:", this.mccmnc);
              } catch (error) {
                console.error("网络提供商解析失败:", error);
                this.networkProvider = "N/A";
                this.mccmnc = "00000";
              }

              // --- APN ---
              try {
                console.log("开始解析APN...");
                const cgcontrdpLine = lines.find(line => line.includes("+CGCONTRDP:"));
                if (cgcontrdpLine) {
                  const parts = cgcontrdpLine.split(",");
                  if (parts.length >= 3) {
                    this.apn = parts[2].replace(/"/g, "");
                  }
                }
                console.log("APN:", this.apn);
              } catch (error) {
                console.error("APN解析失败:", error);
                this.apn = "Unknown";
              }

              // --- IP地址 ---
              try {
                console.log("开始解析IP地址...");
                const ipv4Line = lines.find(line => line.includes("IPV4"));
                if (ipv4Line) {
                  const parts = ipv4Line.split(",");
                  // 确保有足够的元素并且索引4存在
                  if (parts.length > 4) {
                    this.ipv4 = parts[4].replace(/"/g, "");
                  } else if (parts.length > 3) {
                    // 尝试备用索引
                    this.ipv4 = parts[3].replace(/"/g, "");
                  }
                }

                const ipv6Line = lines.find(line => line.includes("IPV6"));
                if (ipv6Line) {
                  const parts = ipv6Line.split(",");
                  // 确保有足够的元素并且索引4存在
                  if (parts.length > 4) {
                    this.ipv6 = parts[4].replace(/"/g, "");
                  } else if (parts.length > 3) {
                    // 尝试备用索引
                    this.ipv6 = parts[3].replace(/"/g, "");
                  }
                }
                console.log("IPv4:", this.ipv4);
                console.log("IPv6:", this.ipv6);
              } catch (error) {
                console.error("IP地址解析失败:", error);
                this.ipv4 = "000.000.000.000";
                this.ipv6 = "0000:0000:0000:0000:0000:0000:0000:0000";
              }

              // --- 网络模式 ---
              try {
                console.log("开始解析网络模式...");
                const servingCellLine = lines.find(line => line.includes('+QENG: "servingcell"'));
                if (servingCellLine) {
                  const parts = servingCellLine.split(",");
                  if (parts.length >= 4) {
                    const network_mode = parts[2].replace(/"/g, "");
                    const duplex_mode = parts[3].replace(/"/g, "");

                    if (network_mode == "NR5G-SA") {
                      this.networkMode = duplex_mode == "TDD" ? "5G SA TDD" : "5G SA FDD";
                    } else if (network_mode == "LTE") {
                      this.networkMode = duplex_mode == "TDD" ? "4G LTE TDD" : "4G LTE FDD";
                    }
                  }
                } else {
                  // 尝试备用解析
                  const lteLine = lines.find(line => line.includes('+QENG: "LTE"'));
                  if (lteLine) {
                    this.networkMode = "4G LTE";
                  } else {
                    const nrLine = lines.find(line => line.includes('+QENG: "NR5G-NSA"'));
                    if (nrLine) {
                      this.networkMode = "5G NSA";
                    } else {
                      this.networkMode = "Unknown";
                    }
                  }
                }
                console.log("网络模式:", this.networkMode);
              } catch (error) {
                console.error("网络模式解析失败:", error);
                this.networkMode = "Unknown";
              }

              // --- 频段 ---
              try {
                console.log("开始解析频段...");
                const bands = lines.filter((line) => line.includes("LTE BAND"));
                for (let i = 0; i < bands.length; i++) {
                  bands[i] = bands[i].split(",")[3].replace(/"/g, "");
                }
                const bands_5g = lines.filter((line) => line.includes("NR5G BAND"));
                for (let i = 0; i < bands_5g.length; i++) {
                  bands_5g[i] = bands_5g[i].split(",")[3].replace(/"/g, "");
                }
                if (bands.length > 0 && bands_5g.length > 0) {
                  this.bands = bands.join(", ") + ", " + bands_5g.join(", ");
                } else if (bands.length > 0) {
                  this.bands = bands.join(", ");
                } else if (bands_5g.length > 0) {
                  this.bands = bands_5g.join(", ");
                } else {
                  this.bands = "No Bands";
                }
                console.log("频段:", this.bands);
              } catch (error) {
                console.error("频段解析失败:", error);
                this.bands = "Unknown Bands";
              }

              // --- 带宽 ---
              try {
                console.log("开始解析带宽...");
                const bandwidth_line = lines.find((line) => line.includes('+QENG: "servingcell"'));
                if (!bandwidth_line) {
                  throw new Error("未找到带宽信息");
                }

                if (this.networkMode.includes("5G SA")) {
                  const nr_bw = bandwidth_line.split(",")[11];
                  const calculated_bandwidth = this.calculate_nr_bw(nr_bw);
                  this.bandwidth = "NR " + calculated_bandwidth + " MHz";
                } else if (this.networkMode.includes("4G LTE")) {
                  const lte_bw_ul = bandwidth_line.split(",")[10];
                  const lte_bw_dl = bandwidth_line.split(",")[11];
                  const calculated_bandwidth_ul = this.calculate_lte_bw(lte_bw_ul);
                  const calculated_bandwidth_dl = this.calculate_lte_bw(lte_bw_dl);
                  this.bandwidth = calculated_bandwidth_ul + " UL / " + calculated_bandwidth_dl + " DL MHz";
                } else if (this.networkMode == "5G NSA") {
                  const lte_bandwidth_line = lines.find((line) => line.includes('+QENG: "LTE"'));
                  const lte_bw_ul = lte_bandwidth_line.split(",")[8];
                  const lte_bw_dl = lte_bandwidth_line.split(",")[9];
                  const calculated_bandwidth_ul = this.calculate_lte_bw(lte_bw_ul);
                  const calculated_bandwidth_dl = this.calculate_lte_bw(lte_bw_dl);

                  const nr_bandwidth_line = lines.find((line) => line.includes('+QENG: "NR5G-NSA"'));
                  const nr_bw = nr_bandwidth_line.split(",")[9];
                  const calculated_bandwidth = this.calculate_nr_bw(nr_bw);

                  this.bandwidth = calculated_bandwidth_ul + " UL / " + calculated_bandwidth_dl + " DL MHz" + " / NR " + calculated_bandwidth + " MHz";
                } else {
                  this.bandwidth = "Unknown Bandwidth";
                }
                console.log("带宽:", this.bandwidth);
              } catch (error) {
                console.error("带宽解析失败:", error);
                this.bandwidth = "Unknown Bandwidth";
              }

              // --- E/ARFCN ---
              try {
                console.log("开始解析E/ARFCN...");
                if (this.networkMode.includes("5G SA")) {
                  const nr_pcc_arfcn_line = lines.find(line => line.includes('+QCAINFO: "PCC"'));
                  if (nr_pcc_arfcn_line) {
                    const nr_pcc_arfcn = nr_pcc_arfcn_line.split(",")[1];
                    const nr_scc_arfcn_lines = lines.filter(line => line.includes('+QCAINFO: "SCC"'));
                    if (nr_scc_arfcn_lines.length > 0) {
                      const nr_scc_arfcn = nr_scc_arfcn_lines.map(line => line.split(",")[1]);
                      this.earfcns = nr_pcc_arfcn + ", " + nr_scc_arfcn.join(", ");
                    } else {
                      this.earfcns = nr_pcc_arfcn;
                    }
                  }
                } else if (this.networkMode.includes("4G LTE")) {
                  const lte_pcc_arfcn_line = lines.find(line => line.includes('+QCAINFO: "PCC"'));
                  if (lte_pcc_arfcn_line) {
                    const lte_pcc_arfcn = lte_pcc_arfcn_line.split(",")[1];
                    const lte_scc_arfcn_lines = lines.filter(line => line.includes('+QCAINFO: "SCC"'));
                    if (lte_scc_arfcn_lines.length > 0) {
                      const lte_scc_arfcn = lte_scc_arfcn_lines.map(line => line.split(",")[1]);
                      this.earfcns = lte_pcc_arfcn + ", " + lte_scc_arfcn.join(", ");
                    } else {
                      this.earfcns = lte_pcc_arfcn;
                    }
                  }
                } else if (this.networkMode == "5G NSA") {
                  const lte_pcc_arfcn_line = lines.find(line => line.includes('+QCAINFO: "PCC"'));
                  if (lte_pcc_arfcn_line) {
                    const lte_pcc_arfcn = lte_pcc_arfcn_line.split(",")[1];
                    const lte_scc_arfcn_lines = lines.filter(line => line.includes('+QCAINFO: "SCC"'));
                    if (lte_scc_arfcn_lines.length > 0) {
                      const lte_scc_arfcn = lte_scc_arfcn_lines.map(line => line.split(",")[1]);
                      this.earfcns = lte_pcc_arfcn + ", " + lte_scc_arfcn.join(", ");
                    } else {
                      this.earfcns = lte_pcc_arfcn;
                    }
                  }
                } else {
                  this.earfcns = "Unknown E/ARFCN";
                }
                console.log("E/ARFCN:", this.earfcns);
              } catch (error) {
                console.error("E/ARFCN解析失败:", error);
                this.earfcns = "000";
              }

              // --- PCI ---
              try {
                console.log("开始解析PCI...");
                if (this.networkMode.includes("5G SA")) {
                  const nr_pcc_pci_line = lines.find(line => line.includes('+QCAINFO: "PCC"'));
                  if (nr_pcc_pci_line) {
                    const nr_pcc_pci = nr_pcc_pci_line.split(",")[4];
                    const nr_scc_pci_lines = lines.filter(line => line.includes('+QCAINFO: "SCC"'));
                    if (nr_scc_pci_lines.length > 0) {
                      const nr_scc_pci = nr_scc_pci_lines.map(line => line.split(",")[5]);
                      this.pccPCI = nr_pcc_pci;
                      this.sccPCI = nr_scc_pci.join(", ");
                    } else {
                      this.pccPCI = nr_pcc_pci;
                      this.sccPCI = "-";
                    }
                  }
                } else if (this.networkMode.includes("4G LTE")) {
                  const lte_pcc_pci_line = lines.find(line => line.includes('+QCAINFO: "PCC"'));
                  if (lte_pcc_pci_line) {
                    const lte_pcc_pci = lte_pcc_pci_line.split(",")[5];
                    const lte_scc_pci_lines = lines.filter(line => line.includes('+QCAINFO: "SCC"'));
                    if (lte_scc_pci_lines.length > 0) {
                      const lte_scc_pci = lte_scc_pci_lines.map(line => line.split(",")[5]);
                      this.pccPCI = lte_pcc_pci;
                      this.sccPCI = lte_scc_pci.join(", ");
                    } else {
                      this.pccPCI = lte_pcc_pci;
                      this.sccPCI = "-";
                    }
                  }
                } else if (this.networkMode == "5G NSA") {
                  const pccparts = lines.find(m => m.includes('QCAINFO: "PCC"')).split(":")[1].split(",");
                  const sccarr = lines.filter(m => m.includes('QCAINFO: "SCC"'));
                  const sccpci = [];
                  sccarr.forEach((s) => {
                    const sccparts = s.split(":")[1].split(",");
                    let sccIndex = 5;
                    switch (sccparts.length) {
                      case 8: sccIndex = 4; break;
                      case 13: case 12: case 10: default: sccIndex = 5; break;
                    }
                    sccpci.push(sccparts[sccIndex]);
                  });
                  this.sccPCI = sccpci.join(", ");
                  let pccIndex = 5;
                  switch (pccparts.length) {
                    case 8: pccIndex = 4; break;
                    case 13: case 12: case 10: default: pccIndex = 5; break;
                  }
                  this.pccPCI = pccparts[pccIndex]?.trim();
                } else {
                  this.pccPCI = "0";
                  this.sccPCI = "-";
                }
                console.log("PCC PCI:", this.pccPCI);
                console.log("SCC PCI:", this.sccPCI);
              } catch (error) {
                console.error("PCI解析失败:", error);
                this.pccPCI = "0";
                this.sccPCI = "-";
              }

              // --- 信号信息 ---
              try {
                console.log("开始解析信号信息...");
                const csqLine = lines.find(line => line.includes("+CSQ:"));
                if (csqLine) {
                  this.csq = csqLine.split(" ")[1].replace("+CSQ: ", "").replace(/"/g, "");
                }

                // 尝试获取信号强度
                const servingCellLine = lines.find(line => line.includes('+QENG: "servingcell"'));
                if (servingCellLine) {
                  const parts = servingCellLine.split(",");
                  if (this.networkMode.includes("5G")) {
                    if (parts.length > 12) this.rsrpNR = parts[12].replace(/"/g, "");
                    if (parts.length > 13) this.rsrqNR = parts[13].replace(/"/g, "");
                    if (parts.length > 14) this.sinrNR = parts[14].replace(/"/g, "");
                  } else {
                    if (parts.length > 13) this.rsrpLTE = parts[13].replace(/"/g, "");
                    if (parts.length > 14) this.rsrqLTE = parts[14].replace(/"/g, "");
                    if (parts.length > 16) this.sinrLTE = parts[16].replace(/"/g, "");
                  }
                }

                // 计算信号百分比
                if (this.rsrpNR !== "-") {
                  this.rsrpNRPercentage = this.calculateRSRPPercentage(parseInt(this.rsrpNR));
                  this.signalPercentage = this.rsrpNRPercentage;
                } else if (this.rsrpLTE !== "-") {
                  this.rsrpLTEPercentage = this.calculateRSRPPercentage(parseInt(this.rsrpLTE));
                  this.signalPercentage = this.rsrpLTEPercentage;
                }

                // 计算信号评估
                this.signalAssessment = this.signalQuality(this.signalPercentage);
                console.log("信号评估:", this.signalAssessment);
                console.log("信号百分比:", this.signalPercentage + "%");
              } catch (error) {
                console.error("信号信息解析失败:", error);
              }

              // --- 流量统计 ---
              try {
                console.log("开始解析流量统计...");
                const qgdnrcntLine = lines.find(line => line.includes("+QGDNRCNT:"));
                if (qgdnrcntLine) {
                  const parts = qgdnrcntLine.split(",");
                  this.nrDownload = parts[0].replace("+QGDNRCNT: ", "");
                  this.nrUpload = parts[1];
                }

                const qgdcntLine = lines.find(line => line.includes("+QGDCNT:"));
                if (qgdcntLine) {
                  const parts = qgdcntLine.split(",");
                  this.nonNrDownload = parts[1];
                  this.nonNrUpload = parts[0].replace("+QGDCNT: ", "");
                }

                // 计算总流量
                const totalDownload = parseInt(this.nrDownload || 0) + parseInt(this.nonNrDownload || 0);
                const totalUpload = parseInt(this.nrUpload || 0) + parseInt(this.nonNrUpload || 0);

                this.downloadStat = this.bytesToSize(totalDownload);
                this.uploadStat = this.bytesToSize(totalUpload);
                console.log("下载统计:", this.downloadStat);
                console.log("上传统计:", this.uploadStat);
              } catch (error) {
                console.error("流量统计解析失败:", error);
                this.downloadStat = "0";
                this.uploadStat = "0";
              }

              // --- 小区信息 ---
              try {
                console.log("开始解析小区信息...");
                const servingCellLine = lines.find(line => line.includes('+QENG: "servingcell"'));
                if (servingCellLine) {
                  const parts = servingCellLine.split(",");
                  if (parts.length > 6) {
                    const longCID = parts[6].replace(/"/g, "");
                    this.cellID = "Long " + longCID;

                    // 尝试解析eNBID
                    try {
                      this.eNBID = parseInt(longCID.substring(0, longCID.length - 2), 16);
                    } catch (e) {
                      console.warn("解析eNBID失败:", e);
                      this.eNBID = "Unknown";
                    }
                  }

                  if (parts.length > 8) {
                    const localTac = parts[8].replace(/"/g, "");
                    this.tac = parseInt(localTac, 16) + " (" + localTac + ")";
                  }
                }
                console.log("小区ID:", this.cellID);
                console.log("eNBID:", this.eNBID);
                console.log("TAC:", this.tac);
              } catch (error) {
                console.error("小区信息解析失败:", error);
              }

              // 更新最后更新时间
              this.lastUpdate = new Date().toLocaleString();
              console.log("所有信息解析完成");
            })
            .catch((error) => {
              console.error("获取数据失败:", error);
              this.activeSim = "获取数据出错";
            });
        },

        bytesToSize(bytes) {
          const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
          if (bytes == 0) return "0 Byte";
          const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
          return Math.round(bytes / Math.pow(1024, i), 2) + " " + sizes[i];
        },

        calculate_lte_bw(lte_bw) {
          const BANDWIDTH_MAP = {
            0: 1.4,
            1: 3,
            2: 5,
            3: 10,
            4: 15,
            5: 20,
            6: 40,
            7: 80,
            8: 100,
            9: 200,
          };
          return BANDWIDTH_MAP[lte_bw] || "Unknown";
        },

        calculate_nr_bw(nr_bw) {
          const NR_BANDWIDTH_MAP = {
            0: 5,
            1: 10,
            2: 15,
            3: 20,
            4: 25,
            5: 30,
            6: 40,
            7: 50,
            8: 60,
            9: 70,
            10: 80,
            11: 90,
            12: 100,
            13: 200,
            14: 400,
          };
          return NR_BANDWIDTH_MAP[nr_bw] || "Unknown";
        },

        calculateRSRPPercentage(rsrp) {
          let RSRP_min = -135;
          let RSRP_max = -65;

          if (isNaN(rsrp) || rsrp < -140) {
            return 0;
          }

          let percentage = ((rsrp - RSRP_min) / (RSRP_max - RSRP_min)) * 100;

          if (percentage > 100) percentage = 100;
          if (percentage < 15) percentage = 15;

          return Math.round(percentage);
        },

        calculateRSRQPercentage(rsrq) {
          let RSRQ_min = -20;
          let RSRQ_max = -8;

          if (isNaN(rsrq) || rsrq < -20) {
            return 0;
          }

          let percentage = ((rsrq - RSRQ_min) / (RSRQ_max - RSRQ_min)) * 100;

          if (percentage > 100) percentage = 100;
          if (percentage < 15) percentage = 15;

          return Math.round(percentage);
        },

        calculateSINRPercentage(sinr) {
          let SINR_min = -10;
          let SINR_max = 35;

          if (isNaN(sinr) || sinr < -10) {
            return 0;
          }

          let percentage = ((sinr - SINR_min) / (SINR_max - SINR_min)) * 100;

          if (percentage > 100) percentage = 100;
          if (percentage < 15) percentage = 15;

          return Math.round(percentage);
        },

        signalQuality(percentage) {
          if (percentage >= 80) return "Excellent";
          if (percentage >= 60) return "Good";
          if (percentage >= 40) return "Fair";
          if (percentage >= 0) return "Poor";
          return "No Signal";
        },

        fetchUpTime() {
          fetch("/cgi-bin/get_uptime")
            .then((response) => response.text())
            .then((data) => {
              const days = data.match(/(\d+) day/);
              const hours = data.match(/(\d+) hour/);
              const minutes = data.match(/(\d+) min/);
              const hoursAndMinutes = data.match(/(\d+):(\d+),/);

              if (hoursAndMinutes != null) {
                if (days != null) {
                  this.uptime = `${days[1]} day${days[1] === "1" ? "" : "s"}, ${hoursAndMinutes[1]} hour${hoursAndMinutes[1] === "1" ? "" : "s"} ${hoursAndMinutes[2]} minutes`;
                } else {
                  this.uptime = `${hoursAndMinutes[1]} hour${hoursAndMinutes[1] === "1" ? "" : "s"} ${hoursAndMinutes[2]} minutes`;
                }
              } else if (days != null) {
                if (hours != null) {
                  this.uptime = `${days[1]} day${days[1] === "1" ? "" : "s"}, ${hours[1]} hour${hours[1] === "1" ? "" : "s"}`;
                } else if (minutes != null) {
                  this.uptime = `${days[1]} day${days[1] === "1" ? "" : "s"}, ${minutes[1]} minute${minutes[1] === "1" ? "" : "s"}`;
                } else {
                  this.uptime = `${days[1]} day${days[1] === "1" ? "" : "s"}`;
                }
              } else if (hours != null) {
                this.uptime = `${hours[1]} hour${hours[1] === "1" ? "" : "s"}`;
              } else if (minutes != null) {
                this.uptime = `${minutes[1]} minute${minutes[1] === "1" ? "" : "s"}`;
              } else {
                this.uptime = "Unknown Time";
              }
            });
        },

        updateRefreshRate() {
          if (this.newRefreshRate < 3) {
            this.newRefreshRate = 3;
          }

          clearInterval(this.intervalId);
          this.refreshRate = this.newRefreshRate;
          console.log("刷新率更新为: " + this.refreshRate + "秒");
          localStorage.setItem("refreshRate", this.refreshRate);
          this.init();
        },

        init() {
          this.fetchUpTime();
          const storedRefreshRate = localStorage.getItem("refreshRate");
          this.refreshRate = storedRefreshRate ? parseInt(storedRefreshRate) : 3;
          this.fetchAllInfo();

          fetch("/cgi-bin/get_ping")
            .then((response) => response.text())
            .then((data) => {
              this.internetConnectionStatus = data.trim() === "OK" ? "Connected" : "Disconnected";
            })
            .catch((error) => {
              console.error("Ping请求失败:", error);
              this.internetConnectionStatus = "Disconnected";
            });

          this.lastUpdate = new Date().toLocaleString();
          console.log("初始化完成，刷新率: " + this.refreshRate + "秒");

          this.intervalId = setInterval(() => {
            console.log("定时刷新...");
            this.fetchUpTime();
            this.fetchAllInfo();

            fetch("/cgi-bin/get_ping")
              .then((response) => response.text())
              .then((data) => {
                this.internetConnectionStatus = data.trim() === "OK" ? "Connected" : "Disconnected";
              })
              .catch((error) => {
                console.error("Ping请求失败:", error);
                this.internetConnectionStatus = "Disconnected";
              });

            this.lastUpdate = new Date().toLocaleString();
          }, this.refreshRate * 1000);
        },
      };
    }
  </script>
</body>

</html>
